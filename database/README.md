# VitalWatch - Scripts de Base de Datos

Este directorio contiene los scripts SQL necesarios para configurar la base de datos Oracle Cloud.

## Archivos

### create_alertas_mq_table.sql
Script principal para crear la tabla `ALERTAS_MQ` que almacena las alertas recibidas desde RabbitMQ.

## Cómo Ejecutar el Script

### Opción 1: Oracle Cloud Console (Web)

1. Accede a Oracle Cloud Console
2. Ve a **Autonomous Database**
3. Selecciona tu base de datos `s58onuxcx4c1qxe9`
4. Click en **Database Actions** > **SQL**
5. Copia y pega el contenido de `create_alertas_mq_table.sql`
6. Click en **Run Script** (ícono de play verde)

### Opción 2: SQL*Plus

```bash
sqlplus ADMIN/tu_password@s58onuxcx4c1qxe9_high
@create_alertas_mq_table.sql
```

### Opción 3: SQL Developer

1. Conecta a la base de datos
2. Abre `create_alertas_mq_table.sql`
3. Ejecuta el script completo (F5)

## Estructura de la Tabla ALERTAS_MQ

| Columna | Tipo | Descripción |
|---------|------|-------------|
| ID | NUMBER | PK, autoincremental |
| PACIENTE_ID | NUMBER | ID del paciente |
| PACIENTE_NOMBRE | VARCHAR2(100) | Nombre del paciente |
| SALA | VARCHAR2(50) | Sala hospitalaria |
| CAMA | VARCHAR2(50) | Número de cama |
| ANOMALIAS_JSON | CLOB | JSON con anomalías detectadas |
| ANOMALIAS_COUNT | NUMBER | Cantidad de anomalías |
| SEVERITY | VARCHAR2(20) | Severidad (CRITICA, ALTA, MEDIA) |
| FRECUENCIA_CARDIACA | NUMBER | FC en lpm |
| PRESION_SISTOLICA | NUMBER | PS en mmHg |
| PRESION_DIASTOLICA | NUMBER | PD en mmHg |
| TEMPERATURA | VARCHAR2(10) | Temperatura en °C |
| SATURACION_OXIGENO | NUMBER | SpO2 en % |
| FRECUENCIA_RESPIRATORIA | NUMBER | FR en rpm |
| DEVICE_ID | VARCHAR2(100) | ID del dispositivo |
| DETECTED_AT | TIMESTAMP | Momento de detección |
| SAVED_AT | TIMESTAMP | Momento de guardado |
| QUEUE_NAME | VARCHAR2(100) | Cola RabbitMQ origen |

## Índices Creados

- `IDX_ALERTAS_PACIENTE`: Por PACIENTE_ID
- `IDX_ALERTAS_SEVERITY`: Por SEVERITY
- `IDX_ALERTAS_DETECTED`: Por DETECTED_AT (DESC)
- `IDX_ALERTAS_PAC_FECHA`: Compuesto (PACIENTE_ID, DETECTED_AT)
- `IDX_ALERTAS_SALA`: Por SALA

## Consultas Útiles

### Ver últimas alertas
```sql
SELECT ID, PACIENTE_ID, PACIENTE_NOMBRE, SEVERITY, ANOMALIAS_COUNT, DETECTED_AT
FROM ALERTAS_MQ
ORDER BY DETECTED_AT DESC
FETCH FIRST 10 ROWS ONLY;
```

### Alertas críticas de hoy
```sql
SELECT *
FROM ALERTAS_MQ
WHERE SEVERITY = 'CRITICA'
  AND TRUNC(DETECTED_AT) = TRUNC(SYSDATE)
ORDER BY DETECTED_AT DESC;
```

### Resumen por severidad
```sql
SELECT SEVERITY, COUNT(*) AS TOTAL, 
       MIN(DETECTED_AT) AS PRIMERA,
       MAX(DETECTED_AT) AS ULTIMA
FROM ALERTAS_MQ
GROUP BY SEVERITY
ORDER BY TOTAL DESC;
```

### Alertas por paciente
```sql
SELECT PACIENTE_ID, PACIENTE_NOMBRE, 
       COUNT(*) AS TOTAL_ALERTAS,
       SUM(CASE WHEN SEVERITY='CRITICA' THEN 1 ELSE 0 END) AS CRITICAS
FROM ALERTAS_MQ
GROUP BY PACIENTE_ID, PACIENTE_NOMBRE
ORDER BY TOTAL_ALERTAS DESC;
```

## Verificación Post-Instalación

Después de ejecutar el script, verifica:

```sql
-- Verificar que la tabla existe
SELECT COUNT(*) FROM ALERTAS_MQ;

-- Verificar la secuencia
SELECT SEQ_ALERTAS_MQ.NEXTVAL FROM DUAL;

-- Verificar índices
SELECT INDEX_NAME, STATUS 
FROM USER_INDEXES 
WHERE TABLE_NAME = 'ALERTAS_MQ';
```

## Notas Importantes

- La tabla usa `GENERATED BY DEFAULT AS IDENTITY` para el ID
- El trigger `TRG_ALERTAS_SAVED_AT` actualiza `SAVED_AT` automáticamente
- Los índices mejoran el rendimiento de consultas frecuentes
- El campo `ANOMALIAS_JSON` es de tipo CLOB para soportar JSON grande

## Troubleshooting

### Error: "table or view does not exist"
La tabla no ha sido creada. Ejecuta el script completo.

### Error: "name is already used by an existing object"
La tabla ya existe. Puedes:
1. Usar la tabla existente
2. Descomentar las líneas DROP al inicio del script para recrearla

### Error de permisos
Asegúrate de estar conectado como usuario ADMIN o con permisos suficientes.
