# VitalWatch - Consumidor 1: Guardador de Alertas en Oracle Cloud

Microservicio consumidor que escucha la cola `vital-signs-alerts` de RabbitMQ y persiste las alertas en Oracle Autonomous Database.

## Funcionalidad

- Consume mensajes de la cola `vital-signs-alerts`
- Deserializa alertas de JSON
- Guarda alertas en la tabla `ALERTAS_MQ` de Oracle Cloud
- Implementa retry logic y manejo de errores
- Soporta procesamiento concurrente

## Tabla Oracle

### ALERTAS_MQ
```sql
CREATE TABLE ALERTAS_MQ (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PACIENTE_ID NUMBER NOT NULL,
    PACIENTE_NOMBRE VARCHAR2(100) NOT NULL,
    SALA VARCHAR2(50) NOT NULL,
    CAMA VARCHAR2(50) NOT NULL,
    ANOMALIAS_JSON CLOB NOT NULL,
    ANOMALIAS_COUNT NUMBER NOT NULL,
    SEVERITY VARCHAR2(20) NOT NULL,
    FRECUENCIA_CARDIACA NUMBER,
    PRESION_SISTOLICA NUMBER,
    PRESION_DIASTOLICA NUMBER,
    TEMPERATURA VARCHAR2(10),
    SATURACION_OXIGENO NUMBER,
    FRECUENCIA_RESPIRATORIA NUMBER,
    DEVICE_ID VARCHAR2(100),
    DETECTED_AT TIMESTAMP NOT NULL,
    SAVED_AT TIMESTAMP NOT NULL,
    QUEUE_NAME VARCHAR2(100) NOT NULL
);

CREATE SEQUENCE SEQ_ALERTAS_MQ START WITH 1 INCREMENT BY 1;
CREATE INDEX IDX_ALERTAS_PACIENTE ON ALERTAS_MQ(PACIENTE_ID);
CREATE INDEX IDX_ALERTAS_SEVERITY ON ALERTAS_MQ(SEVERITY);
CREATE INDEX IDX_ALERTAS_DETECTED ON ALERTAS_MQ(DETECTED_AT);
```

## Configuración

### Variables de Entorno
- `RABBITMQ_HOST`: Host de RabbitMQ
- `RABBITMQ_PORT`: Puerto de RabbitMQ
- `RABBITMQ_USERNAME`: Usuario de RabbitMQ
- `RABBITMQ_PASSWORD`: Contraseña de RabbitMQ
- `QUEUE_ALERTS`: Nombre de la cola (vital-signs-alerts)
- `ORACLE_URL`: JDBC URL de Oracle Cloud
- `ORACLE_USERNAME`: Usuario de Oracle (ADMIN)
- `ORACLE_PASSWORD`: Contraseña de Oracle

### Oracle Wallet
El consumidor requiere el Oracle Wallet montado en `/app/wallet`

## Ejecución

### Local
```bash
mvn spring-boot:run
```

### Docker
```bash
docker build -t consumer-db-saver .
docker run consumer-db-saver
```

### Docker Compose
```bash
docker-compose up consumer-db-saver
```

## Características

- **Retry Logic**: 3 intentos con backoff
- **Concurrencia**: 3-10 workers concurrentes
- **Batch Processing**: Optimizado para inserts por lotes
- **Error Handling**: Logging detallado de errores
- **Monitoring**: Estadísticas de mensajes procesados/fallidos
